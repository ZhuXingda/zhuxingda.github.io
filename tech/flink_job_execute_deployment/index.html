<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Flink】Flink 任务执行和部署原理 - Zhu Xingda</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="欢迎来到朱兴达的个人博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">欢迎来到朱兴达的个人博客</div>
					<div class="logo__tagline">Welcome to Zhu Xingda&#39;s Personal Blog</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">主页-Index</span>
				
			</a>
		</li>
		<li class="menu__item menu__item--active">
			<a class="menu__link" href="/tech/">
				
				<span class="menu__text">技术-Tech</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/note/">
				
				<span class="menu__text">笔记本-NoteBook</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="">
				
				<span class="menu__text">生活-Life</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/%E5%85%B3%E4%BA%8E%E6%88%91-about-me/">
				
				<span class="menu__text">关于我-About Me</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Flink】Flink 任务执行和部署原理</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2025-04-24T17:22:01&#43;08:00">2025-04-24</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" rel="category">分布式系统</a>
	</span>
</div></div>
		</header>
		
		
		<div class="content post__content clearfix">
			<p>分析 Flink 任务完整的提交过程，主要关注在这个过程中任务的格式变化和调度执行。</p>
<h2 id="代码分析">代码分析</h2>
<h4 id="1-sql-任务解析提交">1. SQL 任务解析提交</h4>
<h6 id="11-sql-解析">1.1 SQL 解析</h6>
<ol>
<li>ParserImpl#parse</li>
<li>alciteParser#parseSqlList： SQL -&gt; SqlNode</li>
<li>SqlNodeConverters#convertSqlNode：SqlNode -&gt; Operation</li>
<li>Planner#translate： Operation -&gt; Transformation<br>
4.1. PlannerBase#translateToRel：ModifyOperation -&gt; RelNode<br>
4.2. Optimizer#optimize：RelNode -&gt; RelNode<br>
4.3. ExecNodeGraphGenerator#generate：FlinkPhysicalRel -&gt; ExecNode -&gt; ExecNodeGraph<br>
4.4. PlannerBase#translateToPlan：ExecNodeGraph -&gt; List&lt;Transformation<?>&gt;</li>
<li>Executor#createPipeline：List&lt;Transformation<?>&gt; -&gt; Pipeline<br>
5.1 StreamGraphGenerator#generate：List&lt;Transformation<?>&gt; -&gt; StreamGraph</li>
</ol>
<h6 id="12-任务提交">1.2 任务提交</h6>
<ol>
<li>DefaultExecutor#executeAsync</li>
<li>StreamExecutionEnvironment#executeAsync</li>
<li>PipelineExecutor#execute</li>
<li>AbstractSessionClusterExecutor#execute 以提交任务到 Session Cluster 为例<br>
4.1 FlinkPipelineTranslator#translateToJobGraph：Pipeline -&gt; JobGraph</li>
<li>ClusterClient#submitJob</li>
<li>RestClusterClient#submitJob 将 JobGraph 序列化到文件，再将文件作为请求体通过 HTTP 发送给 JobManager</li>
</ol>
<h4 id="2-streaming-任务解析提交">2. Streaming 任务解析提交</h4>
<ol>
<li>DataStream#transform 编写 Flink Streaming 任务定义各个算子时，是在定义一个个 Transformation</li>
<li>StreamExecutionEnvironment#addOperator Transformation 被添加到 StreamExecutionEnvironment</li>
<li>StreamExecutionEnvironment#execute 将汇总的 Transformation 转换为 StreamGraph，然后提交到集群</li>
<li>PipelineExecutor#execute 后面就和 SQL 提交的流程一致了</li>
</ol>
<h4 id="3-任务调度和执行">3. 任务调度和执行</h4>
<h6 id="31-jobmaster-初始化">3.1 JobMaster 初始化</h6>
<ol>
<li>Dispatcher#createJobMasterRunner JobManager 接收请求，创建 JobManagerRunner 并启动</li>
<li>JobMasterServiceLeadershipRunner#start</li>
<li>JobMasterServiceLeadershipRunner#createNewJobMasterServiceProcess 选主之后创建 JobMasterService</li>
<li>DefaultJobMasterServiceFactory#internalCreateJobMasterService 创建 JobMaster，JobGraph 作为参数</li>
<li>SchedulerNGFactory#createInstance 创建 SchedulerNG -&gt; SchedulerBase -&gt; DefaultScheduler</li>
<li>SchedulerBase#createAndRestoreExecutionGraph：JobGrap -&gt; ExecutionGraph</li>
<li>SchedulingStrategyFactory#createInstance 创建 SchedulingStrategy，参数有 ExecutionGraph 的 SchedulingTopology 和 DefaultScheduler 本身</li>
</ol>
<h6 id="32-jobmaster-调度和执行">3.2 JobMaster 调度和执行</h6>
<ol>
<li>JobMaster#onStart 启动</li>
<li>JobMaster#startScheduling 开始调度</li>
<li>SchedulerBase#startScheduling 调度器执行调度逻辑</li>
<li>SchedulingStrategy#startScheduling SchedulingStrategy 有 PipelinedRegionSchedulingStrategy 和 VertexwiseSchedulingStrategy 两个实现，对应 streaming 任务和 batch 任务的调度策略，这里以 PipelinedRegionSchedulingStrategy 为例</li>
<li>PipelinedRegionSchedulingStrategy#startScheduling 开始调度 region，具体的调度逻辑在后文详细分析</li>
<li>PipelinedRegionSchedulingStrategy#scheduleRegion 将 SchedulingPipelinedRegion 下的 ExecutionVertexID List 分配到 Slot</li>
<li>DefaultScheduler#allocateSlotsAndDeploy 转换 ExecutionVertexID -&gt; JobVertexID -&gt; ExecutionVertex -&gt; Execution ，然后将一批 Execution List 分配到 Slot</li>
<li>DefaultExecutionDeployer#allocateSlotsAndDeploy
<ul>
<li>绑定 Slot：</li>
</ul>
<ol>
<li>DefaultExecutionDeployer#allocateSlotsFor Execution -&gt; ExecutionAttemptID ， 交由 ExecutionSlotAllocator 执行 Slot 分配</li>
<li>ExecutionSlotAllocator#allocateSlotsFor 该接口有 SimpleExecutionSlotAllocator 和 SlotSharingExecutionSlotAllocator 两个实现，后者支持将一个 ExecutionSlotSharingGroup 里的 Execution 分配到同一个 Slot 运行</li>
<li>SlotSharingExecutionSlotAllocator#allocateSlotsFor 使用 SlotSharingStrategy 将 Execution 的 ExecutionVertexID 分配到 ExecutionSlotSharingGroup，然后将 ExecutionSlotSharingGroup 绑定到 LogicalSlot</li>
</ol>
<ul>
<li>部署到 Slot：</li>
</ul>
<ol>
<li>DefaultExecutionDeployer#createDeploymentHandles 创建 ExecutionDeploymentHandle</li>
<li>DefaultExecutionDeployer#waitForAllSlotsAndDeploy -&gt; DefaultExecutionDeployer#deployAll -&gt; DefaultExecutionDeployer#deployOrHandleError -&gt; DefaultExecutionOperations#deploy -&gt; Execution#deploy</li>
</ol>
</li>
</ol>
<h2 id="总结">总结</h2>
<h4 id="任务格式变化">任务格式变化</h4>
<ol>
<li>SQL 任务：<br>
SQL -&gt; SqlNode -&gt; Operation -&gt; RelNode -&gt; ExecNode -&gt; ExecNodeGraph -&gt; Transformation -&gt; StreamGraph -&gt; JobGraph -&gt; ExecutionGraph</li>
<li>Streaming 任务：<br>
Transformation -&gt; StreamGraph -&gt; JobGraph -&gt; ExecutionGraph</li>
</ol>
<h4 id="任务格式结构">任务格式结构</h4>
<ol>
<li>StreamGraph
StreamGraph 由 StreamNode 组成，每个 StreamNode 对应一个 StreamOperator</li>
<li>JobGraph
JobGraph 由 JobVertex 组成</li>
<li>ExecutionGraph
ExecutionGraph 由 ExecutionJobVertex 组成</li>
</ol>
<img src="https://nightlies.apache.org/flink/flink-docs-master/fig/job_and_execution_graph.svg"><h4 id="任务调度执行">任务调度执行</h4>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/flink/" rel="tag">Flink</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: '5e216fcfdd8cdb462b85',
    clientSecret: '10659215d325c41513a047c07f576e345e697b3b',
    repo: 'zhuxingda.github.io',
    owner: 'ZhuXingda',
    admin: ['ZhuXingda'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/tech/data_index_structure/" rel="prev">
			<span class="pager__subtitle">«&thinsp;上一篇</span>
			<p class="pager__title">Bloom Filter、 Bitmap、 Skip List </p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/tech/tcpdump_usage_notebook/" rel="next">
			<span class="pager__subtitle">下一篇&thinsp;»</span>
			<p class="pager__title">【Linux】Linux 服务器抓包记录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2025 Zhu Xingda.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> 主题</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>