<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Ray】分布式计算框架 Ray 入门 - Zhu Xingda</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="上下而求索" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">上下而求索</div>
					<div class="logo__tagline">朱兴达的个人博客</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">主页</span>
				
			</a>
		</li>
		<li class="menu__item menu__item--active">
			<a class="menu__link" href="/tech/">
				
				<span class="menu__text">技术</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/note/">
				
				<span class="menu__text">笔记本</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/life/">
				
				<span class="menu__text">生活</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/%E5%85%B3%E4%BA%8E%E6%88%91/">
				
				<span class="menu__text">关于我</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Ray】分布式计算框架 Ray 入门</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2024-09-16T00:00:00Z">2024-09-16</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" rel="category">分布式系统</a>
	</span>
</div></div>
		</header>
		
		
		<div class="content post__content clearfix">
			<p><strong>Ray</strong> 是一个开源的分布式计算框架，当前主要被应用于机器学习领域。</p>
<p>相比于常用的分布式计算框架 Spark 和 Flink，Ray 提供了更为灵活通用的 API，开发者无需遵循一套固定的编程规则（比如 Spark 和 Flink 里的各种算子）就可以将本地运行的 Python 应用部署到分布式环境执行。</p>
<h2 id="ray-core">Ray Core</h2>
<p>Ray Core 是 Ray 分布式计算的核心组件，逻辑上包含以下概念：</p>
<ul>
<li><strong>Tasks</strong>：在分布式环境下异步执行的无状态函数</li>
<li><strong>Actors</strong>：由 class 定义的有状态的 worker，分布式执行时 worker 的状态可以被读取和修改</li>
<li><strong>Objects</strong>：tasks 和 actors 执行过程中创建和计算的数据对象，被保存在由 Ray Cluster 维护的分布式对象存储中</li>
<li><strong>Placement Groups</strong>：定义一组在集群保留的资源，执行 tasks 或 actors 时使用</li>
</ul>
<h2 id="ray-cluster">Ray Cluster</h2>
<h4 id="集群架构">集群架构</h4>
<img alt="一个简单 Ray 集群的架构图" src="https://docs.ray.io/en/latest/_images/ray-cluster.svg" width="700px"><p>一个 Ray 集群由一个 head node 和多个 worker node 组成。</p>
<ul>
<li><strong>Worker Node</strong><br>
负责执行用户代码，支持集群的调度，组成集群的分布式对象存储。</li>
<li><strong>Head Node</strong><br>
在 woker node 的职责上额外负责集群的管理（可配置仅运行管理进程），包括：
<ul>
<li>Autoscaling：管理资源的进程，当集群需要的资源不足时自动扩大 worker node 规模，worker node idle 时缩减。</li>
<li>Global Control Store（GCS）：存储 Ray 集群的 metadata。</li>
<li>Driver Process：交互式开发时负责在 Ray Cluster 上启动用户的代码。</li>
</ul>
</li>
</ul>
<h4 id="kuberay">KubeRay</h4>
<p>KubeRay 是在 Kubernetes 上部署和管理 Ray 集群的 Kubernetes Operator，类似 Flink 以前版本提供的 Flink Kubernetes Operator。<br>
KubeRay 提供了三种部署模式：</p>
<ul>
<li>RayCluster：部署和管理一个 Ray 集群，包括销毁、扩缩容、容错，可以多次提交任务，类似 Flink 的 Session Mode。</li>
<li>RayJob：启动一个 Ray 集群并提交一个任务在该集群运行，任务结束后支持自动销毁该集群，类似 Flink 的 Application Mode。</li>
<li>RayService：部署 Ray 集群并运行 Ray Serve 应用，支持动态调整 Ray Serve 配置，无损升级 Ray 集群，并提供高可用支持。</li>
</ul>
<h4 id="用-kuberay-部署一个-ray-cluster">用 KubeRay 部署一个 Ray Cluster</h4>
<p>因为我的 Kubernetes 在局域网环境没有外网访问，所以需要手动部署</p>
<ol>
<li><strong>安装 Helm</strong><br>
从 Helm 的 <a href="https://github.com/helm/helm/releases">Github 仓库</a> 下载编译好的二进制，解压后放在 /usr/local/bin/ 目录下。</li>
<li><strong>安装 KubeRay</strong><br>
在有外网的机器上用 docker 从 docker hub 拉取 kuberay-operator 的镜像，并推送到私有仓库</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker image pull quay.io/kuberay/operator:v1.2.2
</span></span><span style="display:flex;"><span>$ docker tag quay.io/kuberay/operator:v1.2.2 local.repo.com/kuberay/operator:v1.2.2
</span></span><span style="display:flex;"><span>$ docker push local.repo.com/kuberay/operator:v1.2.2
</span></span></code></pre></div><p>从 <a href="https://github.com/ray-project/kuberay-helm">Github仓库</a> 下载 kuberay-operator v1.2.2 的压缩包，解压后修改 kuberay-operator/values.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 修改为私有仓库地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">local.repo.com/kuberay/operator</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">v1.2.2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">imagePullSecrets</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">localrepo-secret-token</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 修改 port 避免和其他服务冲突</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">9080</span>
</span></span></code></pre></div><p>helm 安装 kuberay-operator<br>
创建 namespace 和私有仓库的 docker-registry secret</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl create namesapce kuberay-operator
</span></span><span style="display:flex;"><span>$ kubectl create secret docker-registry localrepo-secret-token --docker-server<span style="color:#f92672">=</span>local.repo.com --docker-username<span style="color:#f92672">=</span>$USERNAME --docker-password<span style="color:#f92672">=</span>$PASSWORD -n kuberay-operator
</span></span></code></pre></div><p>helm 打包并安装 kuberay-operator</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm package kuberay-operator
</span></span><span style="display:flex;"><span>Successfully packaged chart and saved it to: /xxxx/helm-chart/kuberay-operator-1.2.2.tgz
</span></span><span style="display:flex;"><span>$ helm install kuberay-operator ./kuberay-operator-1.2.2.tgz
</span></span></code></pre></div><p>启动后发现 pod 状态报错</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get pods -o wide -n kuberay-operator
</span></span><span style="display:flex;"><span>NAME                                READY   STATUS             RESTARTS      AGE    IP             NODE                          NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>kuberay-operator-5b5d75db55-gz8cw   0/1     CrashLoopBackOff   <span style="color:#ae81ff">4</span> <span style="color:#f92672">(</span>15s ago<span style="color:#f92672">)</span>   114s   10.100.6.110   host-07   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>$ kubectl logs -f kuberay-operator-5b5d75db55-gz8cw -n kuberay-operator
</span></span><span style="display:flex;"><span>exec /manager: exec format error
</span></span></code></pre></div><p>检查 kuberay 的代码发现 manager 是 ray-operator 编译后的二进制，&ldquo;exec format error&rdquo; 这个报错常见于 golang 的二进制跨平台运行，原因是前面从 docker hub 拉取镜像的机器是 MAC OS，回退到第一步重新拉取镜像，用 crictl 删除掉 kubernetes 集群上的本地镜像，其他操作不变</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker image pull --platform linux/amd64 quay.io/kuberay/operator:v1.2.2
</span></span><span style="display:flex;"><span>$ crictl rmi local.repo.com/kuberay/operator:v1.2.2
</span></span></code></pre></div><p>重新安装成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get pods -n kuberay-operator
</span></span><span style="display:flex;"><span>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kuberay-operator-5b5d75db55-65kwf   1/1     Running   <span style="color:#ae81ff">0</span>          3m55s
</span></span></code></pre></div><p>同时发现安装时还创建了 3 个 CustomResourceDefinition</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get crd -n kuberay-operator
</span></span><span style="display:flex;"><span>NAME                 CREATED AT
</span></span><span style="display:flex;"><span>rayclusters.ray.io   2025-02-25T11:25:27Z
</span></span><span style="display:flex;"><span>rayjobs.ray.io       2025-02-25T11:25:27Z
</span></span><span style="display:flex;"><span>rayservices.ray.io   2025-02-25T11:25:28Z
</span></span></code></pre></div><ol start="3">
<li><strong>部署 Ray Cluster</strong><br>
同样在有外网的机器上拉取 ray 的镜像并推到私有仓库</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ docker image pull --platform linux/amd64 rayproject/ray:2.9.0
</span></span><span style="display:flex;"><span>$ docker tag rayproject/ray:2.9.0 local.repo.com/rayproject/ray:2.9.0
</span></span><span style="display:flex;"><span>$ docker push local.repo.com/rayproject/ray:2.9.0
</span></span></code></pre></div><p>从 <a href="https://github.com/ray-project/kuberay-helm">Github仓库</a> 下载 ray-cluster-1.2.2.tgz 并解压，修改 values.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">image</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">local.repo.com/rayproject/ray</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tag</span>: <span style="color:#ae81ff">2.9.0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">nameOverride</span>: <span style="color:#e6db74">&#34;kuberay&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fullnameOverride</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imagePullSecrets</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">localrepo-secret-token</span>
</span></span></code></pre></div><p>helm 打包安装 ray-cluster</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ helm package ray-cluster
</span></span><span style="display:flex;"><span>$ helm install ray-cluster ./ray-cluster-1.2.2.tgz -n kuberay-operator
</span></span></code></pre></div><p>运行后发现 head 节点拉不起来，排查发现如下异常</p>
<blockquote>
<p>The node was low on resource: ephemeral-storage. Threshold quantity: 2214605502, available: 1443468Ki.</p>
</blockquote>
<p>即临时存储空间不足，根据 <a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/#configurations-for-local-ephemeral-storage">官方文档</a> 本地临时性存储默认为 /var/lib/kubelet，排查发现该目录确实已无太多剩余空间，迁移后重试部署成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get pods -n kuberay-operator
</span></span><span style="display:flex;"><span>NAME                                           READY   STATUS    RESTARTS       AGE
</span></span><span style="display:flex;"><span>kuberay-operator-5b5d75db55-65kwf              1/1     Running   <span style="color:#ae81ff">82</span> <span style="color:#f92672">(</span>84m ago<span style="color:#f92672">)</span>   1d
</span></span><span style="display:flex;"><span>ray-cluster-kuberay-head-vbdcr                 1/1     Running   <span style="color:#ae81ff">0</span>              1m
</span></span><span style="display:flex;"><span>ray-cluster-kuberay-workergroup-worker-kjvfk   1/1     Running   <span style="color:#ae81ff">0</span>              1m
</span></span><span style="display:flex;"><span>$ kubectl get rayclusters -n kuberay-operator
</span></span><span style="display:flex;"><span>NAME                  DESIRED WORKERS   AVAILABLE WORKERS   CPUS   MEMORY   GPUS   STATUS   AGE
</span></span><span style="display:flex;"><span>ray-cluster-kuberay   <span style="color:#ae81ff">1</span>                 <span style="color:#ae81ff">1</span>                   <span style="color:#ae81ff">2</span>      3G       <span style="color:#ae81ff">0</span>      ready    1m
</span></span></code></pre></div><ol start="4">
<li><strong>提交任务</strong><br>
按照官方文档提交一个简单的测试Job</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ export HEAD_POD<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pods --selector<span style="color:#f92672">=</span>ray.io/node-type<span style="color:#f92672">=</span>head -o custom-columns<span style="color:#f92672">=</span>POD:metadata.name --no-headers -n kuberay-operator<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>$ kubectl exec -it $HEAD_POD -n kuberay-operator -- python -c <span style="color:#e6db74">&#34;import ray; ray.init(); print(ray.cluster_resources())&#34;</span>
</span></span><span style="display:flex;"><span>2024-09-09 20:27:21,035 INFO worker.py:1405 -- Using address 127.0.0.1:6379 set in the environment variable RAY_ADDRESS
</span></span><span style="display:flex;"><span>2024-09-09 20:27:21,035 INFO worker.py:1540 -- Connecting to existing Ray cluster at address: 10.100.7.132:6379...
</span></span><span style="display:flex;"><span>2024-09-09 20:27:21,042 INFO worker.py:1715 -- Connected to Ray cluster. View the dashboard at http://10.100.7.132:8265 
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#39;CPU&#39;</span>: 2.0, <span style="color:#e6db74">&#39;node:10.100.7.133&#39;</span>: 1.0, <span style="color:#e6db74">&#39;memory&#39;</span>: 3000000000.0, <span style="color:#e6db74">&#39;object_store_memory&#39;</span>: 669735320.0, <span style="color:#e6db74">&#39;node:__internal_head__&#39;</span>: 1.0, <span style="color:#e6db74">&#39;node:10.100.7.132&#39;</span>: 1.0<span style="color:#f92672">}</span>
</span></span></code></pre></div><ol start="5">
<li><strong>Dashboard</strong><br>
将 Dashboard 的端口暴露到集群外</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl port-forward --address 0.0.0.0 pods/ray-cluster-kuberay-head-vbdcr 8265:8265 -n kuberay-operator
</span></span></code></pre></div><p>访问 http://&lt;节点IP&gt;:8265/ 即可看到刚才提交的Job</p>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/ray/" rel="tag">Ray</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: '5e216fcfdd8cdb462b85',
    clientSecret: '10659215d325c41513a047c07f576e345e697b3b',
    repo: 'zhuxingda.github.io',
    owner: 'ZhuXingda',
    admin: ['ZhuXingda'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/tech/high_availability_k8s_cluster_build/" rel="prev">
			<span class="pager__subtitle">«&thinsp;上一篇</span>
			<p class="pager__title">【Kubernetes】高可用 Kubernetes 集群搭建（with kubeadm）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/tech/flink_sink_api/" rel="next">
			<span class="pager__subtitle">下一篇&thinsp;»</span>
			<p class="pager__title">【Flink】Flink Data Sink API</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2025 Zhu Xingda.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> 主题</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>