<!DOCTYPE html>
<html class="no-js" lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Flink】Taskmanager 内存管理 - Zhu Xingda</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="上下而求索" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">上下而求索</div>
					<div class="logo__tagline">朱兴达的个人博客</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">菜单</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">主页</span>
				
			</a>
		</li>
		<li class="menu__item menu__item--active">
			<a class="menu__link" href="/tech/">
				
				<span class="menu__text">技术</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/note/">
				
				<span class="menu__text">笔记本</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="">
				
				<span class="menu__text">生活</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/%E5%85%B3%E4%BA%8E%E6%88%91/">
				
				<span class="menu__text">关于我</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Flink】Taskmanager 内存管理</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2023-01-03T00:00:00Z">2023-01-03</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" rel="category">分布式系统</a>
	</span>
</div></div>
		</header>
		
		
		<div class="content post__content clearfix">
			<p>Flink Taskmanager 的内存划分和调整策略。</p>
<h3 id="flink-taskmanager-内存模型">Flink Taskmanager 内存模型</h3>
<p>整个内存模型物理上分为 <strong>JVM Heap</strong> 和 <strong>Off-Heap</strong> 两部分，逻辑上可以分为 <strong>Total Process Memory</strong> 和 <strong>Total Flink Memory</strong> 两部分。  <br>
<strong>Total Process Memory</strong> 为整个 Flink JVM 进程使用的全部内存</p>
<blockquote>
<p><strong>Total Process Memory</strong> = Total Flink Memory + JVM Metaspace + JVM Overhead</p>
</blockquote>
<p>配置项为 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-flink-size">taskmanager.memory.flink.size</a> 和 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-process-size">	taskmanager.memory.process.size</a>，两个选项配置任意一个即可。对于 Kubernetes session mode 部署，在启动 session 时使用 <strong>taskmanager.memory.process.size</strong> 配置。</p>
<h5 id="jvm-heap-堆内存">JVM Heap (堆内存)</h5>
<ol>
<li><strong>Framework Heap Memory</strong> <br>
Flink 框架运行所需要使用的内存，配置项为 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-framework-heap-size">taskmanager.memory.framework.heap.size</a>，默认值为 128 MB，一般不建议修改。</li>
<li><strong>Task Heap Memory</strong><br>
Flink 任务算子和用户代码运行使用的内存，配置项为<a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-task-heap-size">taskmanager.memory.task.heap.size</a>，默认值为 <strong>Total Flink Memory</strong> 减去 <strong>Framework Heap Memory</strong>, <strong>Framework Off-Heap Memory</strong>, <strong>Task Off-Heap Memory</strong>, <strong>Managed Memory</strong> 和 <strong>Network Memory</strong></li>
</ol>
<h5 id="off-heap非堆内存">Off-Heap（非堆内存）</h5>
<ol>
<li>
<p><strong>Managed memory</strong><br>
由 Flink 内存管理器管理的非堆内存，主要用于：</p>
<ul>
<li>内置算法：排序、哈希表、缓存中间结果</li>
<li>RocksDB state backend。</li>
<li>Python UDFs</li>
</ul>
<p>配置项为 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-managed-size">taskmanager.memory.managed.size</a> 和 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-managed-fraction">taskmanager.memory.managed.fraction</a>。默认为 Total Flink Memory 的 40%。</p>
<p>对于不使用三种功能的场景，可以把 taskmanager.memory.managed.fraction 设置为 0，来增大用户代码能使用的内存。</p>
</li>
<li>
<p><strong>Framework Off-Heap Memory</strong><br>
Flink 框架运行所需要使用的非堆内存，配置项为 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-framework-off-heap-size">taskmanager.memory.framework.off-heap.size</a>，默认值为 128 MB，不建议修改。</p>
</li>
<li>
<p><strong>Task Off-Heap Memory</strong><br>
Flink 任务算子和用户代码运行使用的非堆内存，配置项为 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-task-off-heap-size">taskmanager.memory.task.off-heap.size</a>，默认值为 0，如果用户代码里有用到非堆内存的情况，需要手动设置。</p>
</li>
<li>
<p><strong>Network Memory</strong><br>
TaskManager 之间传输数据用到的直接内存，比如网络缓存，配置项为 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-network-min">taskmanager.memory.network.min</a> <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-network-max">taskmanager.memory.network.max</a> <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-network-fraction">taskmanager.memory.network.fraction</a>，网络缓存调优<a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/memory/network_mem_tuning/">相关指南</a>。默认值为 Total Flink Memory 的 10%，最大不默认没有上限，最小默认 64MB。</p>
</li>
<li>
<p><strong>JVM Metaspace</strong> 和 <strong>JVM Overhead</strong><br>
JVM Metaspace 和 JVM Overhead 的内存，配置项为 <a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/config/#taskmanager-memory-jvm-metaspace-size">taskmanager.memory.jvm-metaspace.size
</a> <a href="/">taskmanager.memory.jvm-overhead.fraction</a> 等。其中 Overhead 默认为 <strong>Total Process Memory</strong> 的 10%，最大默认不超过 1024MB，最小默认大于 192MB；Metaspace 默认为 256MB。</p>
</li>
</ol>
<h3 id="on-kubernetes-cluster-具体配置">On Kubernetes Cluster 具体配置</h3>
<p>如果按如下配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># taskmanager 向 k8s 申请的总内存大小</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">taskmanager.memory.process.size</span>: <span style="color:#ae81ff">8192m</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># taskmanager.memory.managed.fraction 设为 0，增大用户代码能使用的内存</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">taskmanager.memory.managed.fraction</span>: <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>最后分配结果就是：</p>
<ul>
<li><strong>Framework Heap Memory</strong> 128MB</li>
<li><strong>Managed Memory</strong> 0MB</li>
<li><strong>Framework Off-Heap Memory</strong> 128MB</li>
<li><strong>Task Off-Heap Memory</strong> 0MB</li>
<li><strong>Network Memory</strong> (8192MB - 256MB - 819MB) * 0.1 = 712 MB</li>
<li><strong>JVM Metaspace</strong> 256MB</li>
<li><strong>JVM Overhead</strong> 8192MB * 0.1 = 819MB</li>
<li><strong>Task Heap Memory</strong> 8192MB - 128MB - 128MB - 0MB - 819MB - 256MB - 712MB = 6149MB</li>
</ul>
<h3 id="参考">参考</h3>
<p><a href="https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/memory/mem_setup_tm/">https://nightlies.apache.org/flink/flink-docs-release-1.20/docs/deployment/memory/mem_setup_tm/</a></p>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/flink/" rel="tag">Flink</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: '5e216fcfdd8cdb462b85',
    clientSecret: '10659215d325c41513a047c07f576e345e697b3b',
    repo: 'zhuxingda.github.io',
    owner: 'ZhuXingda',
    admin: ['ZhuXingda'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

<nav class="pager flex">
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/tech/flink_fault_tolerance/" rel="next">
			<span class="pager__subtitle">下一篇&thinsp;»</span>
			<p class="pager__title">【Flink】Fault Tolerance 原理和实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2025 Zhu Xingda.
			<span class="footer__copyright-credits">基于 <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> 引擎和 <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> 主题</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>